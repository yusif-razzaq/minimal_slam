# Minimal SLAM - LiDAR-Only Implementation

A clean, focused SLAM implementation using **only LiDAR data** for mobile robots. No IMU, no wheel encoders required!

---

## üìã Table of Contents

1. [Overview](#overview)
2. [Quick Start](#quick-start)
3. [How It Works](#how-it-works)
4. [Your Rosbag Data](#your-rosbag-data)
5. [RViz Setup](#rviz-setup)
6. [Saving Your Map](#saving-your-map)
7. [Configuration](#configuration)
8. [Troubleshooting](#troubleshooting)
9. [Performance Tips](#performance-tips)
10. [Project Structure](#project-structure)
11. [Advanced Usage](#advanced-usage)
12. [Requirements](#requirements)

---

## üéØ Overview

This package generates 2D occupancy grid maps from laser scan data using:
- **RF2O** - Laser-based odometry (replaces wheel encoders)
- **SLAM Toolbox** - Graph-based SLAM with loop closure
- **RViz** - Real-time visualization

**Perfect for:** Testing SLAM with recorded rosbag data or deploying on robots with only 2D LiDAR.

### Key Features

‚úÖ **Simple** - One launch file, minimal configuration  
‚úÖ **No encoders needed** - Uses laser scan matching  
‚úÖ **No IMU needed** - Pure LiDAR solution  
‚úÖ **Loop closure** - Automatic drift correction  
‚úÖ **Real-time** - Works with live sensors or rosbags  
‚úÖ **Visualization** - RViz integration included  

---

## üöÄ Quick Start

### 1. Install Dependencies

```bash
sudo apt install \
  ros-humble-slam-toolbox \
  ros-humble-rf2o-laser-odometry \
  ros-humble-robot-state-publisher \
  ros-humble-nav2-map-server \
  ros-humble-rviz2
```

### 2. Build Package

```bash
cd ~/dev_ws
colcon build --packages-select minimal_slam
source install/setup.bash
```

### 3. Launch SLAM (Terminal 1)

```bash
ros2 launch minimal_slam slam_lidar_only.launch.py
```

This starts:
- ‚úÖ Robot state publisher (TF frames)
- ‚úÖ RF2O laser odometry (generates `/odom` from `/scan`)
- ‚úÖ SLAM Toolbox (builds map)
- ‚úÖ RViz (visualization)

### 4. Play Rosbag (Terminal 2)

```bash
cd ~/dev_ws/src/minimal_slam/robot_data
ros2 bag play rosbag2_2025_12_03-00_42_27_0.db3
```

### 4. Save Map (Terminal 3)

After rosbag completes or while looping:
```bash
ros2 run nav2_map_server map_saver_cli -f ~/my_robot_map
```

**Note:** If you get an error about not receiving map data, make sure to save **while** the rosbag is playing (use `--loop` flag).

---

## üìä How It Works

### Pipeline Overview

```
Rosbag Playback
    ‚Üì
/scan (LaserScan @ 7.7 Hz)
    ‚Üì
    ‚îú‚îÄ‚Üí RF2O Laser Odometry
    ‚îÇ       ‚îú‚îÄ‚Üí /odom (Odometry)
    ‚îÇ       ‚îî‚îÄ‚Üí TF: odom ‚Üí base_footprint
    ‚îÇ
    ‚îî‚îÄ‚Üí SLAM Toolbox
            ‚îú‚îÄ‚Üí /map (OccupancyGrid)
            ‚îî‚îÄ‚Üí TF: map ‚Üí odom
```

### Key Components

#### 1. RF2O (Range Flow 2D Odometry)
- Compares consecutive laser scans
- Estimates how much the robot moved between scans
- Replaces wheel encoders entirely
- Publishes to `/odom` topic

**How it works:**
1. Takes current laser scan
2. Compares to previous scan
3. Finds transformation (x, y, Œ∏) that best aligns them
4. Publishes this as odometry

#### 2. SLAM Toolbox
- Uses `/scan` for mapping
- Uses `/odom` for localization
- Builds 2D occupancy grid map
- Performs loop closure (corrects drift)

#### 3. Robot State Publisher
- Publishes static robot transforms
- Defines sensor positions from URDF
- Provides base coordinate frames

### Transform Tree

```
map
 ‚îî‚îÄ odom (from SLAM)
     ‚îî‚îÄ base_footprint (from RF2O)
         ‚îî‚îÄ base_link (from URDF)
             ‚îî‚îÄ laser (from URDF)
```

### Traditional vs LiDAR-Only SLAM

**Traditional SLAM:**
```
Wheel Encoders ‚Üí Odometry ‚Üí SLAM ‚Üí Map
LiDAR ‚Üí Scan Matching ‚Üó
```

**LiDAR-Only SLAM (this implementation):**
```
LiDAR ‚Üí Scan Matching (RF2O) ‚Üí Odometry ‚Üí SLAM ‚Üí Map
```

**Key difference:** RF2O estimates motion by comparing consecutive laser scans, eliminating the need for wheel encoders.

---

## üì¶ Your Rosbag Data

### File: `rosbag2_2025_12_03-00_42_27_0.db3`

**File Info:**
- **Size:** 17.7 MB
- **Duration:** 181.83 seconds (~3 minutes)
- **Total Messages:** 15,257
- **Recording Date:** Dec 2, 2025

### Topic Breakdown

| Topic | Type | Messages | Rate | Usage |
|-------|------|----------|------|-------|
| `/scan` | LaserScan | 1,396 | ~7.7 Hz | ‚úÖ **Used for SLAM** |
| `/cmd_vel` | Twist | 1,693 | ~9.3 Hz | ‚ÑπÔ∏è Robot commands (not needed) |
| `/imu/gyro` | Vector3 | 3,552 | ~19.5 Hz | ‚ùå Not used |
| `/imu/accel` | Vector3 | 3,552 | ~19.5 Hz | ‚ùå Not used |
| `/hallway_lidar_data` | Float32MultiArray | 1,589 | - | ‚ùå Custom format (not needed) |

### Data Quality Assessment

| Metric | Value | Assessment |
|--------|-------|------------|
| Scan rate | 7.7 Hz | ‚úÖ Good for SLAM |
| Duration | 3 minutes | ‚úÖ Sufficient |
| Messages | 1,396 scans | ‚úÖ Adequate coverage |
| Odometry | Generated by RF2O | ‚ö†Ô∏è Less accurate than encoders but works well |

**Note:** Your rosbag does **NOT** contain pre-computed odometry (`/odom_rf2o`). We generate it in real-time using RF2O.

---

## üé® RViz Setup

When RViz opens, configure it for best visualization:

### 1. Set Fixed Frame
- In **Global Options**, set **Fixed Frame** to `map`

### 2. Add TF Display
- Shows robot coordinate frames
- Helps debug transform issues

### 3. Add LaserScan Display
- **Topic:** `/scan`
- **Style:** Points or Flat Squares
- **Color Transformer:** By Range or Intensity
- **Size:** 0.05
- **Decay Time:** 0 (for rosbag playback)

### 4. Add Map Display
- **Topic:** `/map`
- **Color Scheme:** map
- **Alpha:** 0.7

### 5. Add Odometry Display
- **Topic:** `/odom`
- **Keep:** 100 (shows trail)
- **Shaft Length:** 0.5
- **Shaft Radius:** 0.05
- **Color:** Your choice

### 6. Add Path Display (Optional)
- **Topic:** `/slam_toolbox/graph_visualization`
- Shows SLAM graph nodes and connections

### What You'll See During Playback

**Terminal 1 (SLAM launch):**
```
[rf2o_laser_odometry]: Processing scan...
[rf2o_laser_odometry]: Odom: x=1.23, y=0.45, theta=0.12
[slam_toolbox]: Node added to graph
[slam_toolbox]: Map updated
```

**RViz Window:**
- Red/rainbow laser points moving around
- Gray/white/black map building progressively
- Blue arrow showing robot pose
- Green/blue trail showing robot path

---

## üíæ Saving Your Map

### Method 1: Standard Map Saver (Recommended)

After rosbag playback, save the map:

```bash
ros2 run nav2_map_server map_saver_cli -f ~/my_robot_map
```

**Output files:**
- `~/my_robot_map.pgm` - Map image (grayscale)
- `~/my_robot_map.yaml` - Map metadata

**Important:** Save **while** the rosbag is playing (use `--loop` flag) or immediately after it finishes. If you wait too long, the map topic may stop publishing.

### Method 2: SLAM Toolbox Serialization

Save the internal SLAM state:

```bash
ros2 service call /slam_toolbox/serialize_map slam_toolbox/srv/SerializePoseGraph "{filename: '/home/yusif/maps/my_slam_session'}"
```

### Viewing Your Map

```bash
# Using image viewer
eog ~/my_robot_map.pgm

# Using GIMP
gimp ~/my_robot_map.pgm

# Using ImageMagick
display ~/my_robot_map.pgm
```

### Map Format

**PGM File** (Image):
- Grayscale image (0-255)
- 0 = Black = Occupied (walls/obstacles)
- 255 = White = Free space (navigable)
- 127 = Gray = Unknown (not explored)

**YAML File** (Metadata):
```yaml
image: my_robot_map.pgm
resolution: 0.05              # 5cm per pixel
origin: [-26.54, -32.65, 0.0] # Bottom-left corner in meters
negate: 0
occupied_thresh: 0.65         # 65% probability = occupied
free_thresh: 0.196            # ~20% probability = free
```

---

## ‚öôÔ∏è Configuration

### RF2O Parameters

In `launch/slam_lidar_only.launch.py`:

```python
parameters=[{
    'laser_scan_topic': '/scan',
    'odom_topic': '/odom',
    'publish_tf': True,           # RF2O publishes odom‚Üíbase transform
    'base_frame_id': 'base_footprint',
    'odom_frame_id': 'odom',
    'freq': 10.0,                 # Update at 10 Hz
    'verbose': True,              # Show status messages
    'use_sim_time': True          # Use rosbag timestamps
}]
```

### SLAM Toolbox Parameters

In `config/slam.yaml`:

```yaml
slam_toolbox:
  ros__parameters:
    # Topics and frames
    scan_topic: /scan
    odom_frame: odom
    base_frame: base_footprint
    map_frame: map
    
    # Scan matching (important for LiDAR-only!)
    use_scan_matching: true
    use_scan_barycenter: true
    
    # Map resolution
    resolution: 0.05  # 5cm per pixel
    max_laser_range: 10.0
    
    # Update thresholds
    minimum_travel_distance: 0.2  # meters
    minimum_travel_heading: 0.2   # radians
    
    # Loop closure
    do_loop_closing: true
    loop_match_minimum_chain_size: 10
    
    # Map updates
    map_update_interval: 2.0  # seconds
    transform_publish_period: 0.02
```

**No tuning needed for first run!** Default settings work well for most indoor environments.

---

## üêõ Troubleshooting

### Problem: RF2O not publishing odometry

**Symptoms:**
- No `/odom` topic
- Warning: "Waiting for laser scan..."

**Check:**
```bash
ros2 topic hz /scan
ros2 topic echo /scan --once
ros2 node list | grep rf2o
```

**Solution:**
- Ensure rosbag is playing
- Verify `/scan` topic exists and has data
- Check RF2O node is running

---

### Problem: Transform timeout errors

**Symptoms:**
```
Could not transform laser scan into base_footprint
Lookup would require extrapolation into the future
```

**Solution:**
1. Make sure ALL nodes have `use_sim_time: True` (already set in launch file)
2. Check TF tree: `ros2 run tf2_tools view_frames`
3. Verify robot_state_publisher is running: `ros2 node list`

---

### Problem: Map not building

**Symptoms:**
- RViz shows laser scans but no map
- SLAM Toolbox not outputting messages

**Check:**
```bash
# Is SLAM receiving scans?
ros2 topic hz /scan

# Is odometry available?
ros2 topic hz /odom

# Is map being published?
ros2 topic hz /map
```

**Expected rates:**
- `/scan`: ~7.7 Hz
- `/odom`: ~7.7 Hz (generated by RF2O)
- `/map`: ~0.5 Hz (updated periodically by SLAM)

**Solution:**
- Wait 10-20 seconds for first map updates
- Check SLAM Toolbox console for errors
- Verify environment has features (not empty space)
- Ensure TF transforms are working

---

### Problem: Poor map quality (wavy walls, drift)

**Symptoms:**
- Wavy or doubled walls
- Large drift over time
- Ghosted features

**Possible Causes:**
1. Fast motion during recording
2. Featureless environment
3. Low scan rate
4. RF2O struggling to match scans

**Solutions:**

#### 1. Play Slower
```bash
ros2 bag play rosbag2_2025_12_03-00_42_27_0.db3 --rate 0.5
```

#### 2. Tune RF2O (Advanced)
Create `config/rf2o.yaml`:
```yaml
/**:
  ros__parameters:
    laser_scan_topic: /scan
    odom_topic: /odom
    max_iterations: 10        # Tighter convergence
    publish_tf: true
```

#### 3. Tune SLAM (Advanced)
Edit `config/slam.yaml`:
```yaml
slam_toolbox:
  ros__parameters:
    # Stronger scan matching
    link_match_minimum_response_fine: 0.3
    minimum_travel_distance: 0.15
    
    # More aggressive loop closure
    do_loop_closing: true
    loop_match_minimum_chain_size: 5
```

---

### Problem: "Old messages" warning

**Symptoms:**
```
Message filter dropping message: frame 'laser' at time X
```

**Solution:**
Use `--clock` flag:
```bash
ros2 bag play rosbag2_2025_12_03-00_42_27_0.db3 --clock
```

---

### Problem: Map saver fails with "Failed to spin map subscription"

**Symptoms:**
```
[ERROR] [map_saver]: Failed to spin map subscription
```

**Cause:** Map topic stopped publishing after rosbag finished.

**Solution:**
```bash
# Play rosbag in loop mode
ros2 bag play rosbag2_2025_12_03-00_42_27_0.db3 --loop

# In another terminal, save map WHILE playing
ros2 run nav2_map_server map_saver_cli -f ~/my_robot_map
```

---

## üéØ Performance Tips

### Environment Requirements

**‚úÖ Works Best In:**
- Indoor structured environments (rooms, offices, warehouses)
- Areas with visible features (walls, furniture, obstacles)
- Slow to moderate robot speeds
- 2D ground robot applications

**‚ö†Ô∏è Challenging For:**
- Empty hallways or long corridors
- Outdoor open spaces
- Featureless environments
- High-speed motion
- 3D environments

### Motion Recommendations

- **Slower motion** = better scan matching
- **Avoid sudden rotations** - gradual turns work better
- **Smooth trajectories** - consistent speed preferred
- **Regular scanning** - maintain 5-10 Hz scan rate

### Expected Results

With the included rosbag data:
- **Map size:** ~1000√ó800 pixels (50√ó40 meters)
- **Resolution:** 5cm per pixel
- **Quality:** Good for indoor environments
- **Drift:** Minimal (<0.5m over 3 minutes)
- **Loop closures:** 1-5 (if robot revisited areas)

### Good Map Indicators

- ‚úÖ Straight walls (not wavy)
- ‚úÖ Closed loops (if robot revisited areas)
- ‚úÖ Consistent features
- ‚úÖ Minimal drift (<1m over 3 minutes)
- ‚úÖ Clear obstacle boundaries

### Poor Map Indicators

- ‚ùå Doubled/ghosted walls
- ‚ùå Broken or disconnected features
- ‚ùå Large drift (robot ends far from start)
- ‚ùå Fuzzy or unclear boundaries

---

## üìÅ Project Structure

```
minimal_slam/
‚îú‚îÄ‚îÄ CMakeLists.txt                  # Build configuration
‚îú‚îÄ‚îÄ package.xml                     # ROS 2 package metadata
‚îú‚îÄ‚îÄ README.md                       # This file
‚îÇ
‚îú‚îÄ‚îÄ launch/
‚îÇ   ‚îî‚îÄ‚îÄ slam_lidar_only.launch.py  # Main launch file
‚îÇ
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ slam.yaml                  # SLAM Toolbox parameters
‚îÇ
‚îú‚îÄ‚îÄ urdf/
‚îÇ   ‚îî‚îÄ‚îÄ ackermann_car.xacro        # Robot description (TF frames)
‚îÇ
‚îî‚îÄ‚îÄ robot_data/
    ‚îú‚îÄ‚îÄ rosbag2_*.db3              # Example rosbag data
    ‚îú‚îÄ‚îÄ metadata.yaml              # Rosbag information
    ‚îú‚îÄ‚îÄ my_robot_map.pgm           # Generated map (example)
    ‚îî‚îÄ‚îÄ my_robot_map.yaml          # Map metadata (example)
```

**Total: 11 core files** - Clean and minimal!

---

## üîß Advanced Usage

### Playback Options

```bash
# Normal speed (real-time)
ros2 bag play rosbag2_2025_12_03-00_42_27_0.db3

# Slow motion (better visualization)
ros2 bag play rosbag2_2025_12_03-00_42_27_0.db3 --rate 0.5

# Fast forward (quick testing)
ros2 bag play rosbag2_2025_12_03-00_42_27_0.db3 --rate 1.5

# Loop continuously
ros2 bag play rosbag2_2025_12_03-00_42_27_0.db3 --loop

# With clock publishing
ros2 bag play rosbag2_2025_12_03-00_42_27_0.db3 --clock

# Start from specific time (skip first 30 seconds)
ros2 bag play rosbag2_2025_12_03-00_42_27_0.db3 --start-offset 30
```

### Monitoring Performance

```bash
# Check topic rates
ros2 topic hz /scan
ros2 topic hz /odom
ros2 topic hz /map

# View transform tree
ros2 run tf2_tools view_frames  # Creates frames.pdf

# Check specific transform
ros2 run tf2_ros tf2_echo odom base_footprint

# Monitor odometry
ros2 topic echo /odom --once

# Check SLAM pose
ros2 topic echo /slam_toolbox/pose

# Monitor scan match score (higher = better)
ros2 topic echo /slam_toolbox/scan_match_score
```

### Adapting to Your Robot

To use with your own robot (not rosbag):

1. **Update URDF** (`urdf/ackermann_car.xacro`) with your robot's:
   - Physical dimensions
   - Sensor positions (LiDAR location)
   - Frame names

2. **Modify launch file** (`launch/slam_lidar_only.launch.py`):
   - Set `use_sim_time: False` (for live robot)
   - Remove static_tf_pub if not needed
   - Add your LiDAR driver node

3. **Configure topics**:
   - Ensure your LiDAR publishes to `/scan`
   - Or remap in launch file

4. **Launch and drive:**
```bash
ros2 launch minimal_slam slam_lidar_only.launch.py
```

---

## üìö Requirements

### System Requirements

- **OS:** Ubuntu 22.04 (or compatible)
- **ROS:** ROS 2 Humble
- **Python:** 3.10+
- **RAM:** 2GB minimum, 4GB recommended
- **CPU:** Multi-core recommended for real-time performance

### ROS 2 Packages

```bash
sudo apt install \
  ros-humble-slam-toolbox \
  ros-humble-rf2o-laser-odometry \
  ros-humble-robot-state-publisher \
  ros-humble-nav2-map-server \
  ros-humble-rviz2 \
  ros-humble-tf2-ros \
  ros-humble-tf2-tools
```

### Hardware Requirements (for physical robot)

**Minimum:**
- 2D LiDAR sensor (RPLidar A1, Hokuyo, etc.)
- Publishing `sensor_msgs/LaserScan` to `/scan`
- 5-10 Hz scan rate minimum

**Recommended:**
- 360¬∞ scanning LiDAR
- 10+ Hz scan rate
- 10m+ range
- Good angular resolution (<1¬∞)

---

## üéì Understanding LiDAR-Only SLAM

### Advantages

- ‚úÖ **No wheel encoder calibration** - eliminates common error source
- ‚úÖ **No wheel slippage errors** - works on any surface
- ‚úÖ **Works on any robot** - with 2D LiDAR
- ‚úÖ **Simpler hardware** - fewer sensors needed
- ‚úÖ **Self-contained** - no external odometry required

### Limitations

- ‚ö†Ô∏è **Less accurate than encoders** in open spaces
- ‚ö†Ô∏è **Needs textured environment** (walls, furniture, obstacles)
- ‚ö†Ô∏è **Can fail in featureless spaces** (long empty hallways)
- ‚ö†Ô∏è **Slower update rate** than encoder-based odometry
- ‚ö†Ô∏è **Requires good scan rate** (5-10 Hz minimum)

### When to Use This Implementation

**Good For:**
- Testing SLAM with recorded data
- Robots without wheel encoders
- Indoor mapping applications
- Learning SLAM concepts
- Prototyping and development

**Not Ideal For:**
- Outdoor navigation in open areas
- High-speed applications
- Environments without features
- 3D mapping requirements

---

## üéâ Complete Workflow Example

Here's a complete end-to-end example:

```bash
# ===== Terminal 1: Build and Launch =====
cd ~/dev_ws
colcon build --packages-select minimal_slam
source install/setup.bash
ros2 launch minimal_slam slam_lidar_only.launch.py

# ===== Terminal 2: Play Rosbag =====
cd ~/dev_ws/src/minimal_slam/robot_data
ros2 bag play rosbag2_2025_12_03-00_42_27_0.db3 --rate 0.8 --loop

# ===== Terminal 3: Monitor (optional) =====
# Watch topic rates
watch -n 1 'ros2 topic hz /scan /odom /map 2>&1 | head -10'

# ===== Terminal 4: Save Map =====
# After 1-2 minutes of playback
ros2 run nav2_map_server map_saver_cli -f ~/robot_map_$(date +%Y%m%d_%H%M%S)

# ===== Stop Everything =====
# Ctrl+C in Terminal 2 (stop rosbag)
# Ctrl+C in Terminal 1 (stop SLAM)

# ===== View Results =====
cd ~
eog robot_map_*.pgm
cat robot_map_*.yaml
```

---

## üìù Citation & Credits

This package uses:
- **SLAM Toolbox** by Steve Macenski - Graph-based SLAM
- **RF2O** by MAPIR Lab (Universidad de M√°laga) - Laser odometry

---

## üìß Support & Contributing

### Getting Help

1. Check the [Troubleshooting](#troubleshooting) section
2. Review [Performance Tips](#performance-tips)
3. Inspect console output for errors
4. Verify rosbag data with `ros2 bag info`

### Common Issues

- **No map appearing:** Wait 20-30 seconds for first updates
- **Transform errors:** Check `use_sim_time` setting
- **Poor quality:** Try slower playback rate
- **Save fails:** Use `--loop` flag and save while playing

---

## üìÑ License

MIT License (or your preferred license)

---

## ‚úÖ Quick Checklist

Before running:
- [ ] Dependencies installed
- [ ] Package built successfully
- [ ] Rosbag file present
- [ ] RF2O package available

During run:
- [ ] SLAM launch successful
- [ ] Rosbag playing
- [ ] Topics publishing (`/scan`, `/odom`, `/map`)
- [ ] RViz showing map building

After run:
- [ ] Map saved successfully
- [ ] Map quality verified
- [ ] Files ready for navigation

---

**Happy Mapping!** üó∫Ô∏è

For questions or issues, review the troubleshooting section or check topic rates and console output for errors.

**ROS Version:** ROS 2 Humble  
**Maintained:** Yes  
**Last Updated:** December 2025
